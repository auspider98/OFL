<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>League — OFC</title>
  <link rel="stylesheet" href="style.css" />
  <script src="admin-config.js"></script>
  <script src="admin.js"></script>
</head>
<body>

  <!-- ── TOP NAV ─────────────────────────────────────────── -->
  <nav class="topnav" role="navigation" aria-label="Site navigation">
    <a href="index.html" class="topnav-logo">OFC</a>
    <button class="menu-trigger" aria-label="Open navigation menu" aria-expanded="false" aria-controls="site-drawer">
      <span></span><span></span><span></span>
    </button>
  </nav>

  <!-- ── DRAWER ──────────────────────────────────────────── -->
  <div class="drawer-overlay" aria-hidden="true"></div>
  <aside id="site-drawer" class="drawer" role="dialog" aria-modal="true" aria-label="Navigation">
    <p class="drawer-label">Navigate</p>
    <ul class="drawer-nav"></ul>
    <div class="drawer-footer"></div>
  </aside>

  <!-- ── LEAGUE PAGE ─────────────────────────────────────── -->
  <div class="league-page" id="leaguePage">

    <!-- Full-page slideshow layers -->
    <div class="slide-layer" id="slideA" aria-hidden="true"></div>
    <div class="slide-layer" id="slideB" aria-hidden="true"></div>
    <div class="landing-overlay" id="heroOverlay" aria-hidden="true"></div>
    <div class="landing-vignette" aria-hidden="true"></div>

    <!-- Hero -->
    <header class="league-hero" id="leagueHero">
      <div class="landing-rule" aria-hidden="true"></div>
      <div class="league-hero-content" id="leagueHeroContent">
        <p class="league-hero-eyebrow" id="leagueEyebrow"></p>
        <h1 class="league-hero-title" id="leagueTitle"></h1>
        <p class="league-hero-subtitle" id="leagueSubtitle"></p>
      </div>
    </header>

    <!-- Body content injected by JS -->
    <div class="league-body" id="leagueBody"></div>

  </div><!-- /leaguePage -->

  <script src="menu.js"></script>

  <script>
  (function () {
    'use strict';

    // ── Helpers ──────────────────────────────────────────────
    function esc(s) {
      return String(s || '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
    }

    function getParam(key) {
      var params = new URLSearchParams(window.location.search);
      return params.get(key) || '';
    }

    function el(id) { return document.getElementById(id); }

    // ── Get league from config ───────────────────────────────
    function getLeague(slug) {
      var config = window.SITE_CONFIG;
      if (!config || !config.leagueData) return null;
      return config.leagueData.find(function (lg) {
        return lg.name && lg.name.toLowerCase() === slug.toLowerCase();
      }) || null;
    }

    // ── Get current season ───────────────────────────────────
    function getCurrentSeason(league) {
      if (!league.seasons || !league.seasons.length) return null;
      if (league.currentSeasonId) {
        var found = league.seasons.find(function (s) { return s.id === league.currentSeasonId; });
        if (found) return found;
      }
      return league.seasons[0];
    }

    // ── Get champion logo: team logo → mugshot fallback ──────
    function getChampionImage(season, config, league) {
      if (!season) return '';
      var member = (config.masterRoster || []).find(function (m) {
        return m.id === season.championMemberId;
      });

      // 1. Season roster logo override
      var rosterEntry = (season.roster || []).find(function (r) {
        return r.memberId === season.championMemberId;
      });
      if (rosterEntry && rosterEntry.logo) return rosterEntry.logo;

      // 2. Master roster team logo for this league
      if (member && member.leagues && league) {
        var lgEntry = member.leagues.find(function (lg) {
          return lg.leagueKey === league.name || lg.leagueName === league.name;
        });
        if (lgEntry && lgEntry.teams && lgEntry.teams.length) {
          // Match by team name if possible, else take first team
          var teamName = season.championTeamName;
          var team = lgEntry.teams.find(function (t) { return t.name === teamName; })
                  || lgEntry.teams[0];
          if (team && team.logo) return team.logo;
        }
      }

      // 3. Mugshot fallback
      return member ? (member.mugshot || '') : '';
    }

    // ── Resolve stat display text ────────────────────────────
    function statDisplay(stat) {
      if (!stat) return '';
      var parts = [];
      if (stat.ownerName)    parts.push(stat.ownerName);
      if (stat.bracketName && stat.bracketName !== stat.ownerName) parts.push('(' + stat.bracketName + ')');
      if (stat.team)         parts.push(stat.team);
      if (stat.score        !== undefined && stat.score !== '') parts.push(stat.score);
      if (stat.points       !== undefined && stat.points !== '') parts.push(stat.points + ' pts');
      if (stat.total        !== undefined && stat.total !== '')  parts.push(stat.total);
      if (stat.count        !== undefined && stat.count !== '')  parts.push(stat.count);
      if (stat.round)        parts.push('(' + stat.round + ')');
      if (stat.week)         parts.push('Wk ' + stat.week);
      return parts.join(' · ');
    }

    /* Returns an array of display strings for all subfields on a stat */
    function statLines(stat) {
      if (!stat) return [];
      var lines = [];
      if (stat.record)                                              lines.push(stat.record);
      if (stat.playerName)                                          lines.push(stat.playerName);
      if (stat.score     !== undefined && stat.score     !== '' && stat.score     !== 0) lines.push(stat.score);
      if (stat.points    !== undefined && stat.points    !== '' && stat.points    !== 0) lines.push(stat.points + ' pts');
      if (stat.total     !== undefined && stat.total     !== '' && stat.total     !== 0) lines.push(stat.total);
      if (stat.count     !== undefined && stat.count     !== '' && stat.count     !== 0) lines.push(stat.count + ' picks');
      if (stat.opponent)                                            lines.push('vs ' + stat.opponent);
      if (stat.margin    !== undefined && stat.margin    !== '' && stat.margin    !== 0) lines.push('Margin: ' + stat.margin);
      if (stat.week      !== undefined && stat.week      !== '' && stat.week      !== 0) lines.push('Week ' + stat.week);
      if (stat.round)                                               lines.push(stat.round);
      if (stat.totalPoints !== undefined && stat.totalPoints !== '' && stat.totalPoints !== 0) lines.push(stat.totalPoints + ' pts');
      return lines;
    }

    // ── Render hero ──────────────────────────────────────────
    function renderHero(league, config) {
      el('leagueEyebrow').textContent  = league.heroEyebrow  || config.landing.eyebrow || '';
      el('leagueTitle').textContent    = league.heroTitle    || league.fullName || league.name || '';
      el('leagueSubtitle').textContent = league.heroSubtitle || '';

      // Apply league accent color
      if (league.accentColor) {
        document.documentElement.style.setProperty('--hint-color', league.accentColor);
      }

      // Page title
      document.title = (league.heroTitle || league.name || 'League') + ' — OFC';
    }

    // ── Render champion display (centered, no box) ──────────
    function renderChampionBlock(season, league, config) {
      var imgSrc   = getChampionImage(season, config, league);
      var year     = season.year || '';
      var team     = season.championTeamName || '';
      var owner    = season.championName || '';
      var score    = season.championshipScore || '';
      var leagName = league.name || '';

      // Per-league champion image size (px), default 160
      var imgSize  = (league.pageLayout && league.pageLayout.championImgSize) || 160;

      var imgHtml = '';
      if (imgSrc) {
        imgHtml = '<div class="champ-display-img-wrap">' +
          '<img src="' + esc(imgSrc) + '" alt="' + esc(team || owner) + '" style="max-width:' + esc(imgSize) + 'px;max-height:' + esc(imgSize) + 'px;width:auto;height:auto;" />' +
        '</div>';
      }

      return '<div class="champ-display">' +
        imgHtml +
        '<div class="champ-display-title">' + esc(year + (year && leagName ? ' ' : '') + leagName + ' Champion') + '</div>' +
        (team  ? '<div class="champ-display-team">'  + esc(team)  + '</div>' : '') +
        (owner ? '<div class="champ-display-owner">' + esc(owner) + '</div>' : '') +
        (score ? '<div class="champ-display-score">' + esc(score) + '</div>' : '') +
      '</div>';
    }

    // ── Render standings table ───────────────────────────────
    function renderStandingsTable(season, league) {
      var schema = window.SPORT_STAT_SCHEMAS[league.sport] || window.SPORT_STAT_SCHEMAS.other;
      var cols   = (schema.standingsColumns || []).filter(function (c) { return c.key !== 'rank' && c.key !== 'owner'; });
      var rows   = season.standings || [];
      if (!rows.length) return '<p style="color:var(--accent-dim);font-size:0.75rem;letter-spacing:0.15em;">No standings data yet.</p>';

      /* Some column keys in the schema differ from the actual stored key on the row */
      var keyAliases = { team: ['teamName', 'bracketName', 'team'] };
      function resolveCell(row, key) {
        var aliases = keyAliases[key] || [key];
        for (var i = 0; i < aliases.length; i++) {
          if (row[aliases[i]]) return row[aliases[i]];
        }
        return '';
      }

      var thead = '<tr><th class="standings-rank-cell">#</th>' +
        cols.map(function (c) { return '<th>' + esc(c.label) + '</th>'; }).join('') + '</tr>';

      var tbody = rows.map(function (row, i) {
        return '<tr>' +
          '<td class="standings-rank-cell">' + esc(row.rank || (i + 1)) + '</td>' +
          cols.map(function (c) { return '<td>' + esc(resolveCell(row, c.key)) + '</td>'; }).join('') +
        '</tr>';
      }).join('');

      return '<table class="league-standings-table"><thead>' + thead + '</thead><tbody>' + tbody + '</tbody></table>';
    }

    // ── Render awards grid ───────────────────────────────────
    function renderAwardsGrid(season, league) {
      var schema      = window.SPORT_STAT_SCHEMAS[league.sport] || window.SPORT_STAT_SCHEMAS.other;
      var awardDefs   = schema.awards      || [];
      var awards      = league.awards      || {};
      var awardImages = league.awardImages  || {};
      var stats       = season.stats        || {};
      var html        = '';

      function thumbHtml(imgSrc) {
        return imgSrc
          ? '<img class="award-card-thumb" src="' + esc(imgSrc) + '" alt="" />'
          : '';
      }

      /* Build a stat/custom award card (not champion) */
      function buildStatCard(name, hint, imgSrc, teamName, detailLines) {
        var hasImg = !!imgSrc;
        var imgCol = hasImg
          ? '<div class="stat-award-img-col"><img src="' + esc(imgSrc) + '" alt="" /></div>'
          : '';
        var infoColClass = 'stat-award-info-col' + (hasImg ? '' : ' full-width');
        var detailHtml = (detailLines || []).map(function (line) {
          return '<div class="stat-award-detail">' + esc(line) + '</div>';
        }).join('');
        return '<div class="stat-award-card">' +
          imgCol +
          '<div class="' + infoColClass + '">' +
            '<div class="stat-award-name">' + esc(name) + '</div>' +
            (hint ? '<div class="stat-award-hint">' + esc(hint) + '</div>' : '') +
            '<div class="stat-award-winner">' + esc(teamName) + '</div>' +
            detailHtml +
          '</div>' +
        '</div>';
      }

      // Champion always first — same layout as other awards
      if (season.championName) {
        var champLines = [];
        if (season.championName && season.championName !== season.championTeamName) champLines.push(season.championName);
        if (season.record)             champLines.push(season.record);
        if (season.championshipScore)  champLines.push(season.championshipScore);
        html += buildStatCard(
          awards['champion'] || 'Champion',
          'Season Champion',
          awardImages['champion'] || '',
          season.championTeamName || season.championName,
          champLines
        );
      }

      // Stats-based awards
      awardDefs.forEach(function (a) {
        if (a.key === 'champion') return;
        var stat = stats[a.key];
        var statDef = (schema.stats || []).find(function (s) { return s.awardKey === a.key; });
        if (statDef) stat = stats[statDef.key];
        if (!stat || (!stat.ownerName && !stat.bracketName)) return;
        html += buildStatCard(
          awards[a.key] || a.defaultLabel,
          a.hint || '',
          awardImages[a.key] || '',
          stat.teamName || stat.bracketName || stat.ownerName || '',
          statLines(stat)
        );
      });

      // Custom awards
      (league.customAwards || []).forEach(function (ca) {
        var entry = (season.customStats || []).find(function (cs) { return cs.customAwardId === ca.id; });
        if (!entry || (!entry.ownerName && !entry.value)) return;
        html += buildStatCard(
          ca.label || 'Custom Award',
          ca.description || '',
          ca.image || '',
          entry.teamName || entry.ownerName || '',
          entry.value ? [entry.value] : []
        );
      });

      return html || '<p style="color:var(--accent-dim);font-size:0.75rem;letter-spacing:0.15em;">No awards data yet.</p>';
    }

    // ── Build past season flip card ──────────────────────────
    function buildPastSeasonCard(season, league, config) {
      var imgSrc  = getChampionImage(season, config, league);
      var year    = season.year || '????';
      var team    = season.championTeamName || '—';
      var owner   = season.championName || '';

      // Respect cardTemplate show flags
      var template = league.cardTemplate || [];
      function fieldVisible(key) {
        if (!template.length) return true;
        var f = template.find(function (t) { return t.key === key; });
        return f ? f.show !== false : true;
      }

      var record  = fieldVisible('record')            ? (season.record || '')             : '';
      var seed    = fieldVisible('seed')              ? (season.seed ? '#' + season.seed : '') : '';
      var score   = fieldVisible('championshipScore') ? (season.championshipScore || '')   : '';

      var logoHtml = imgSrc
        ? '<img class="flip-card-logo" src="' + esc(imgSrc) + '" alt="' + esc(team) + '" />'
        : '';

      var metaHtml = '';
      if (record) metaHtml += '<div class="flip-card-meta-item"><span class="flip-meta-label">Record</span><span class="flip-meta-value">' + esc(record) + '</span></div>';
      if (seed)   metaHtml += '<div class="flip-card-meta-item"><span class="flip-meta-label">Seed</span><span class="flip-meta-value">' + esc(seed) + '</span></div>';
      if (score)  metaHtml += '<div class="flip-card-meta-item"><span class="flip-meta-label">Final</span><span class="flip-meta-value">' + esc(score) + '</span></div>';

      // Back: standings rows
      var standingsRows = (season.standings || []).slice(0, 10).map(function (row, i) {
        return '<div class="flip-back-row">' +
          '<span class="flip-back-rank">' + esc(row.rank || (i+1)) + '</span>' +
          '<span>' + esc(row.owner || row.ownerName || '') + (row.team || row.bracketName ? ' — ' + esc(row.team || row.bracketName) : '') + '</span>' +
        '</div>';
      }).join('');

      var storyHtml = season.story
        ? '<p class="flip-back-story">' + esc(season.story) + '</p>'
        : '';

      var frontHtml =
        '<div class="season-flip-front">' +
          '<div class="flip-card-year">' + esc(year) + '</div>' +
          logoHtml +
          '<div class="flip-card-team">' + esc(team) + '</div>' +
          '<div class="flip-card-owner">' + esc(owner) + '</div>' +
          (metaHtml ? '<div class="flip-card-meta">' + metaHtml + '</div>' : '') +
          '<div class="flip-hint">Details →</div>' +
        '</div>';

      var backHtml =
        '<div class="season-flip-back">' +
          '<div class="flip-back-title">' +
            '<span>' + esc(year) + ' Season</span>' +
            '<span class="flip-back-close">&#x2715;</span>' +
          '</div>' +
          '<div class="flip-back-standings">' + standingsRows + '</div>' +
          storyHtml +
        '</div>';

      var card = document.createElement('div');
      card.className = 'season-flip-card';
      card.innerHTML = '<div class="season-flip-inner">' + frontHtml + backHtml + '</div>';

      card.addEventListener('click', function (e) {
        if (e.target.classList.contains('flip-back-close')) {
          card.classList.remove('is-flipped');
        } else {
          card.classList.toggle('is-flipped');
        }
      });

      return card;
    }

    // ── Render page body ─────────────────────────────────────
    function renderBody(league, config) {
      var body       = el('leagueBody');
      var pl         = league.pageLayout || {};
      var current    = getCurrentSeason(league);
      var pastSeasons = (league.seasons || []).filter(function (s) {
        return s.id !== (current ? current.id : null);
      });

      body.innerHTML = '';
      var revealDelay = 0.8; // start after hero animations

      // ── Current Champion
      if (pl.showChampion !== false && current && current.championName) {
        var sec = document.createElement('div');
        sec.className = 'league-section league-section-first section-reveal';
        sec.style.animationDelay = revealDelay + 's';
        revealDelay += 0.15;
        sec.innerHTML = renderChampionBlock(current, league, config);
        body.appendChild(sec);
      }

      // ── Final Standings
      if (pl.showStandings !== false && current) {
        var sec2 = document.createElement('div');
        sec2.className = 'league-section section-reveal';
        sec2.style.animationDelay = revealDelay + 's';
        revealDelay += 0.15;
        sec2.innerHTML = '<div class="league-section-heading">Final Standings — ' + esc(current.year || '') + '</div>' +
          '<div class="league-standings-wrap">' + renderStandingsTable(current, league) + '</div>';
        body.appendChild(sec2);
      }

      // ── Season Awards
      if (pl.showAwards !== false && current) {
        var sec3 = document.createElement('div');
        sec3.className = 'league-section section-reveal';
        sec3.style.animationDelay = revealDelay + 's';
        revealDelay += 0.15;
        sec3.innerHTML = '<div class="league-section-heading">Season Awards — ' + esc(current.year || '') + '</div>' +
          '<div class="awards-grid" id="awardsGrid"></div>';
        body.appendChild(sec3);
        sec3.querySelector('#awardsGrid').innerHTML = renderAwardsGrid(current, league);
      }

      // ── Past Seasons
      if (pl.showPastSeasons !== false && pastSeasons.length > 0) {
        var sec4 = document.createElement('div');
        sec4.className = 'league-section section-reveal';
        sec4.style.animationDelay = revealDelay + 's';
        revealDelay += 0.15;
        sec4.innerHTML = '<div class="league-section-heading">Past Seasons</div>';
        var grid = document.createElement('div');
        grid.className = 'past-seasons-grid';
        pastSeasons.forEach(function (s) {
          grid.appendChild(buildPastSeasonCard(s, league, config));
        });
        sec4.appendChild(grid);
        body.appendChild(sec4);
      }

      // ── Footer
      var footer = document.createElement('div');
      footer.className = 'league-footer section-reveal';
      footer.style.animationDelay = revealDelay + 's';
      footer.textContent = (league.fullName || league.name || '') + (config.footer && config.footer.text ? ' · ' + config.footer.text : '');
      body.appendChild(footer);
    }

    // ── Init slideshow for league ────────────────────────────
    function initLeagueSlideshow(league, config) {
      var ss = league.slideshow;

      // Apply league overlay directly as inline style (same mechanism as index page)
      var overlayEl = el('heroOverlay');
      var overlayVal = (ss && ss.overlay) ? ss.overlay : 'rgba(0,0,0,0.55)';
      if (overlayEl) overlayEl.style.background = overlayVal;

      if (!ss || !ss.slides || !ss.slides.length) return;

      // Borrow global slideshow timing settings if set
      var displayMs = (config.slideshow && config.slideshow.displayDuration) || 8000;
      var fadeMs    = (config.slideshow && config.slideshow.fadeDuration)    || 2000;
      var cycleMs   = displayMs + fadeMs;
      document.documentElement.style.setProperty('--slide-fade', (fadeMs / 1000) + 's');

      var slideA     = el('slideA');
      var slideB     = el('slideB');
      if (!slideA || !slideB) return;

      var slides     = ss.slides;
      var total      = slides.length;
      var currentIdx = 0;
      var activLayer = slideA;
      var inactLayer = slideB;

      slides.forEach(function (s) { var img = new Image(); img.src = s.image; });

      function applySlide(layer, slide) {
        layer.style.backgroundImage    = 'url("' + slide.image + '")';
        layer.style.animationName      = slide.direction || 'kb-zoom-in';
        layer.style.animationDuration  = cycleMs + 'ms';
        layer.style.animationDelay     = '0ms';
        layer.style.animationPlayState = 'paused';
        layer.classList.add('kb-active');
      }

      function resetLayer(layer) {
        layer.classList.remove('kb-active');
        layer.style.animation = 'none';
        void layer.offsetWidth;
        layer.style.animation = '';
      }

      function showSlide(idx) {
        applySlide(inactLayer, slides[idx]);
        activLayer.style.zIndex  = '1';
        inactLayer.style.zIndex  = '2';
        inactLayer.style.animationPlayState = 'running';
        inactLayer.classList.add('is-active');
        setTimeout(function () {
          activLayer.classList.remove('is-active');
          var out = activLayer; activLayer = inactLayer; inactLayer = out;
          setTimeout(function () { resetLayer(inactLayer); }, 50);
        }, fadeMs);
      }

      applySlide(slideA, slides[0]);
      slideA.style.zIndex = '2';
      slideB.style.zIndex = '1';
      slideA.style.animationPlayState = 'running';
      slideA.classList.add('is-active');
      activLayer = slideA;
      resetLayer(slideB);
      inactLayer = slideB;

      if (total === 1) return;

      function cycle() {
        currentIdx = (currentIdx + 1) % total;
        showSlide(currentIdx);
        setTimeout(cycle, cycleMs);
      }
      setTimeout(cycle, cycleMs);
    }

    // ── Main init ────────────────────────────────────────────
    function init() {
      var config = window.SITE_CONFIG;
      if (!config) { console.warn('SITE_CONFIG not found'); return; }

      var slug   = getParam('league');
      var league = getLeague(slug);

      if (!league) {
        document.title = 'League Not Found — OFC';
        el('leagueTitle').textContent    = slug ? slug.toUpperCase() : 'League';
        el('leagueSubtitle').textContent = 'This league could not be found.';
        return;
      }

      renderHero(league, config);
      initLeagueSlideshow(league, config);
      renderBody(league, config);
    }

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', init);
    } else {
      init();
    }

  })();
  </script>

</body>
</html>
