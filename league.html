<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>OFL</title>
  <link rel="icon" type="image/png" href="assets/favicon.png" />
  <link rel="stylesheet" href="style.css" />
  <script src="admin-config.js"></script>
  <script src="admin.js"></script>
  <style>
    .yahoo-link-wrap {
      text-align: center;
      padding: 0.75rem 1rem 1.25rem;
    }
    .yahoo-link-btn {
      display: inline-flex; align-items: center; gap: 0.5rem;
      font-family: var(--font-body, sans-serif);
      font-size: 0.68rem; font-weight: 600;
      letter-spacing: 0.25em; text-transform: uppercase;
      color: #7B00D4;
      border: 1px solid rgba(123,0,212,0.4);
      padding: 0.55em 1.4em;
      text-decoration: none;
      transition: background 0.2s, border-color 0.2s, color 0.2s;
    }
    .yahoo-link-btn:hover {
      background: rgba(123,0,212,0.1);
      border-color: rgba(123,0,212,0.7);
      color: #9B30FF;
    }
    .yahoo-link-btn svg { flex-shrink: 0; }
  </style>
</head>
<body>

  <!-- ── TOP NAV ─────────────────────────────────────────── -->
  <nav class="topnav" role="navigation" aria-label="Site navigation">
    <a href="index.html" class="topnav-logo">OFC</a>
    <button class="menu-trigger" aria-label="Open navigation menu" aria-expanded="false" aria-controls="site-drawer">
      <span></span><span></span><span></span>
    </button>
  </nav>

  <!-- ── DRAWER ──────────────────────────────────────────── -->
  <div class="drawer-overlay" aria-hidden="true"></div>
  <aside id="site-drawer" class="drawer" role="dialog" aria-modal="true" aria-label="Navigation">
    <p class="drawer-label">Navigate</p>
    <ul class="drawer-nav"></ul>
    <div class="drawer-footer"></div>
  </aside>

  <!-- ── LEAGUE PAGE ─────────────────────────────────────── -->
  <div class="league-page" id="leaguePage">

    <!-- Full-page slideshow layers -->
    <div class="slide-layer" id="slideA" aria-hidden="true"></div>
    <div class="slide-layer" id="slideB" aria-hidden="true"></div>
    <div class="landing-overlay" id="heroOverlay" aria-hidden="true"></div>
    <div class="landing-vignette" aria-hidden="true"></div>

    <!-- Hero -->
    <header class="league-hero" id="leagueHero">
      <div class="landing-rule" aria-hidden="true"></div>
      <div class="league-hero-content" id="leagueHeroContent">
        <p class="league-hero-eyebrow" id="leagueEyebrow"></p>
        <h1 class="league-hero-title" id="leagueTitle"></h1>
        <p class="league-hero-subtitle" id="leagueSubtitle"></p>
      </div>
    </header>

    <!-- Body content injected by JS -->
    <div class="league-body" id="leagueBody"></div>

  </div><!-- /leaguePage -->

  <script src="menu.js"></script>

  <script>
  (function () {
    'use strict';

    // ── Helpers ──────────────────────────────────────────────
    function esc(s) {
      return String(s || '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
    }

    function getParam(key) {
      var params = new URLSearchParams(window.location.search);
      return params.get(key) || '';
    }

    function el(id) { return document.getElementById(id); }

    // ── Get league from config ───────────────────────────────
    function getLeague(slug) {
      var config = window.SITE_CONFIG;
      if (!config || !config.leagueData) return null;
      return config.leagueData.find(function (lg) {
        return lg.name && lg.name.toLowerCase() === slug.toLowerCase();
      }) || null;
    }

    // ── Get current season ───────────────────────────────────
    function getCurrentSeason(league) {
      if (!league.seasons || !league.seasons.length) return null;
      if (league.currentSeasonId) {
        var found = league.seasons.find(function (s) { return s.id === league.currentSeasonId; });
        if (found) return found;
      }
      return league.seasons[0];
    }

    // ── Get champion logo: team logo → mugshot fallback ──────
    function getChampionImage(season, config, league) {
      if (!season) return '';
      var member = (config.masterRoster || []).find(function (m) {
        return m.id === season.championMemberId;
      });

      // 1. Season roster logo override
      var rosterEntry = (season.roster || []).find(function (r) {
        return r.memberId === season.championMemberId;
      });
      if (rosterEntry && rosterEntry.logo) return rosterEntry.logo;

      // 2. Master roster team logo for this league
      if (member && member.leagues && league) {
        var lgEntry = member.leagues.find(function (lg) {
          return lg.leagueKey === league.name || lg.leagueName === league.name;
        });
        if (lgEntry && lgEntry.teams && lgEntry.teams.length) {
          // Match by team name if possible, else take first team
          var teamName = season.championTeamName;
          var team = lgEntry.teams.find(function (t) { return t.name === teamName; })
                  || lgEntry.teams[0];
          if (team && team.logo) return team.logo;
        }
      }

      // 3. Mugshot fallback
      return member ? (member.mugshot || '') : '';
    }

    // ── Resolve stat display text ────────────────────────────
    function statDisplay(stat) {
      if (!stat) return '';
      var parts = [];
      if (stat.ownerName)    parts.push(stat.ownerName);
      if (stat.bracketName && stat.bracketName !== stat.ownerName) parts.push('(' + stat.bracketName + ')');
      if (stat.team)         parts.push(stat.team);
      if (stat.score        !== undefined && stat.score !== '') parts.push(stat.score);
      if (stat.points       !== undefined && stat.points !== '') parts.push(stat.points + ' pts');
      if (stat.total        !== undefined && stat.total !== '')  parts.push(stat.total);
      if (stat.count        !== undefined && stat.count !== '')  parts.push(stat.count);
      if (stat.round)        parts.push('(' + stat.round + ')');
      if (stat.week)         parts.push('Wk ' + stat.week);
      return parts.join(' · ');
    }

    /* Returns an array of display strings for all subfields on a stat */
    function statLines(stat) {
      if (!stat) return [];
      var lines = [];
      if (stat.record)                                              lines.push(stat.record);
      if (stat.playerName)                                          lines.push(stat.playerName);
      if (stat.score     !== undefined && stat.score     !== '' && stat.score     !== 0) lines.push(stat.score);
      if (stat.points    !== undefined && stat.points    !== '' && stat.points    !== 0) lines.push(stat.points + ' pts');
      if (stat.total     !== undefined && stat.total     !== '' && stat.total     !== 0) lines.push(stat.total);
      if (stat.count     !== undefined && stat.count     !== '' && stat.count     !== 0) lines.push(stat.count + ' picks');
      if (stat.opponent)                                            lines.push('vs ' + stat.opponent);
      if (stat.margin    !== undefined && stat.margin    !== '' && stat.margin    !== 0) lines.push('Margin: ' + stat.margin);
      if (stat.week      !== undefined && stat.week      !== '' && stat.week      !== 0) lines.push('Week ' + stat.week);
      if (stat.round)                                               lines.push(stat.round);
      if (stat.totalPoints !== undefined && stat.totalPoints !== '' && stat.totalPoints !== 0) lines.push(stat.totalPoints + ' pts');
      return lines;
    }

    // ── Render hero ──────────────────────────────────────────
    function renderHero(league, config) {
      var pl = league.pageLayout || {};
      var showEyebrow  = pl.showEyebrow  !== false;
      var showTitle    = pl.showTitle    !== false;
      var showSubtitle = pl.showSubtitle !== false;

      el('leagueEyebrow').textContent  = showEyebrow  ? (league.heroEyebrow  || config.landing.eyebrow || '') : '';
      el('leagueTitle').textContent    = showTitle    ? (league.heroTitle    || league.fullName || league.name || '') : '';
      el('leagueSubtitle').textContent = showSubtitle ? (league.heroSubtitle || '') : '';

      // Adjust hero size based on visible fields
      var hero        = el('leagueHero');
      var visibleCount = (showEyebrow ? 1 : 0) + (showTitle ? 1 : 0) + (showSubtitle ? 1 : 0);
      hero.classList.toggle('hero--no-eyebrow',  !showEyebrow);
      hero.classList.toggle('hero--no-title',    !showTitle);
      hero.classList.toggle('hero--no-subtitle', !showSubtitle);
      hero.classList.toggle('hero--minimal',     visibleCount <= 1);
      hero.classList.toggle('hero--empty',       visibleCount === 0);

      // Apply league accent color (legacy field)
      if (league.accentColor) {
        document.documentElement.style.setProperty('--hint-color', league.accentColor);
      }

      // Apply league theme overrides — these supersede Site Settings
      var to = league.themeOverride || {};
      var root = document.documentElement;
      if (to.accentColor)      root.style.setProperty('--accent',        to.accentColor);
      if (to.accentDim)        root.style.setProperty('--accent-dim',    to.accentDim);
      if (to.hintColor)        root.style.setProperty('--hint-color',    to.hintColor);
      if (to.drawerBackground) root.style.setProperty('--drawer-bg',     to.drawerBackground);
      if (to.drawerBorder)     root.style.setProperty('--drawer-border', to.drawerBorder);

      // Page title
      document.title = 'OFL \u2014 ' + (league.heroTitle || league.name || 'League');
    }

    // ── Render champion display (centered, no box) ──────────
    function renderChampionBlock(season, league, config) {
      var imgSrc   = getChampionImage(season, config, league);
      var year     = season.year || '';
      var team     = season.championTeamName || '';
      var owner    = season.championName || '';
      var score    = season.championshipScore || '';
      var leagName = league.name || '';

      // Per-league champion image size (px), default 160
      var imgSize  = (league.pageLayout && league.pageLayout.championImgSize) || 160;

      var imgHtml = '';
      if (imgSrc) {
        imgHtml = '<div class="champ-display-img-wrap">' +
          '<img src="' + esc(imgSrc) + '" alt="' + esc(team || owner) + '" style="max-width:' + esc(imgSize) + 'px;max-height:' + esc(imgSize) + 'px;width:auto;height:auto;" />' +
        '</div>';
      }

      return '<div class="champ-display">' +
        imgHtml +
        '<div class="champ-display-title">' + esc(year + (year && leagName ? ' ' : '') + leagName + ' Champion') + '</div>' +
        (team  ? '<div class="champ-display-team">'  + esc(team)  + '</div>' : '') +
        (owner ? '<div class="champ-display-owner">' + esc(owner) + '</div>' : '') +
        (score ? '<div class="champ-display-score">' + esc(score) + '</div>' : '') +
      '</div>';
    }

    // ── Render standings table ───────────────────────────────
    function renderStandingsTable(season, league, config) {
      var schema     = window.SPORT_STAT_SCHEMAS[league.sport] || window.SPORT_STAT_SCHEMAS.other;
      var isFootball = league.sport === 'football';

      // Use league-level column config if saved, else fall back to schema defaults (all visible)
      var allCols = (league.standingsColumns && league.standingsColumns.length)
        ? league.standingsColumns.filter(function (c) { return c.show !== false; })
        : (schema.standingsColumns || []).map(function (c) { return { key: c.key, label: c.label, show: true }; });

      // Separate rank (always first, fixed) from the rest
      var rankCol = allCols.find(function (c) { return c.key === 'rank'; });
      var cols    = allCols.filter(function (c) { return c.key !== 'rank'; });

      var rows = season.standings || [];
      if (!rows.length) return '<p style="color:var(--accent-dim);font-size:0.75rem;letter-spacing:0.15em;">No standings data yet.</p>';

      /* Some column keys in the schema differ from the actual stored key on the row */
      var keyAliases = { team: ['teamName', 'bracketName', 'team'] };
      function resolveCell(row, key) {
        var aliases = keyAliases[key] || [key];
        for (var i = 0; i < aliases.length; i++) {
          if (row[aliases[i]]) return row[aliases[i]];
        }
        return '';
      }

      /* Build a roster-entry-like object from a standings row for logo lookup */
      function logoForRow(row) {
        if (!isFootball) return '';
        var entry = { memberId: row.memberId || '', teamName: row.teamName || row.team || '' };
        return resolveRosterLogo(entry, league, config);
      }

      function teamCellHtml(row) {
        var teamName = resolveCell(row, 'team');
        if (!isFootball) return esc(teamName);
        var logo    = logoForRow(row);
        var initial = teamName ? teamName.charAt(0).toUpperCase() : '?';
        var imgHtml = logo
          ? '<img class="standings-team-logo" src="' + esc(logo) + '" alt="' + esc(teamName) + '" />'
          : '<span class="standings-team-initial">' + esc(initial) + '</span>';
        return '<span class="standings-team-cell">' + imgHtml + esc(teamName) + '</span>';
      }

      var thead = '<tr>' +
        (rankCol ? '<th class="standings-rank-cell">' + esc(rankCol.label) + '</th>' : '') +
        cols.map(function (c) { return '<th>' + esc(c.label) + '</th>'; }).join('') +
      '</tr>';

      var tbody = rows.map(function (row, i) {
        return '<tr>' +
          (rankCol ? '<td class="standings-rank-cell">' + esc(row.rank || (i + 1)) + '</td>' : '') +
          cols.map(function (c) {
            if (c.key === 'team') return '<td>' + teamCellHtml(row) + '</td>';
            return '<td>' + esc(resolveCell(row, c.key)) + '</td>';
          }).join('') +
        '</tr>';
      }).join('');

      return '<table class="league-standings-table"><thead>' + thead + '</thead><tbody>' + tbody + '</tbody></table>';
    }

    // ── Render awards grid ───────────────────────────────────
    function renderAwardsGrid(season, league) {
      var schema      = window.SPORT_STAT_SCHEMAS[league.sport] || window.SPORT_STAT_SCHEMAS.other;
      var awardDefs   = schema.awards      || [];
      var awards      = league.awards      || {};
      var awardImages = league.awardImages  || {};
      var stats       = season.stats        || {};
      var html        = '';

      function thumbHtml(imgSrc) {
        return imgSrc
          ? '<img class="award-card-thumb" src="' + esc(imgSrc) + '" alt="" />'
          : '';
      }

      /* Build a stat/custom award card (not champion) */
      function buildStatCard(name, hint, imgSrc, teamName, detailLines) {
        var hasImg = !!imgSrc;
        var imgCol = hasImg
          ? '<div class="stat-award-img-col"><img src="' + esc(imgSrc) + '" alt="" /></div>'
          : '';
        var infoColClass = 'stat-award-info-col' + (hasImg ? '' : ' full-width');
        var detailHtml = (detailLines || []).map(function (line) {
          return '<div class="stat-award-detail">' + esc(line) + '</div>';
        }).join('');
        return '<div class="stat-award-card">' +
          imgCol +
          '<div class="' + infoColClass + '">' +
            (hint ? '<div class="stat-award-hint">' + esc(hint) + '</div>' : '') +
            '<div class="stat-award-name">' + esc(name) + '</div>' +
            '<div class="stat-award-winner">' + esc(teamName) + '</div>' +
            detailHtml +
          '</div>' +
        '</div>';
      }

      // Champion always first — same layout as other awards
      if (season.championName) {
        var champLines = [];
        if (season.championName && season.championName !== season.championTeamName) champLines.push(season.championName);
        if (season.record)             champLines.push(season.record);
        if (season.championshipScore)  champLines.push(season.championshipScore);
        html += buildStatCard(
          awards['champion'] || 'Champion',
          'Season Champion',
          awardImages['champion'] || '',
          season.championTeamName || season.championName,
          champLines
        );
      }

      // Stats-based awards
      awardDefs.forEach(function (a) {
        if (a.key === 'champion') return;
        var stat = stats[a.key];
        var statDef = (schema.stats || []).find(function (s) { return s.awardKey === a.key; });
        if (statDef) stat = stats[statDef.key];
        if (!stat || (!stat.ownerName && !stat.bracketName)) return;
        html += buildStatCard(
          awards[a.key] || a.defaultLabel,
          a.hint || '',
          awardImages[a.key] || '',
          stat.teamName || stat.bracketName || stat.ownerName || '',
          statLines(stat)
        );
      });

      // Custom awards
      (league.customAwards || []).forEach(function (ca) {
        var entry = (season.customStats || []).find(function (cs) { return cs.customAwardId === ca.id; });
        if (!entry || (!entry.ownerName && !entry.value)) return;
        html += buildStatCard(
          ca.label || 'Custom Award',
          ca.description || '',
          ca.image || '',
          entry.teamName || entry.ownerName || '',
          entry.value ? [entry.value] : []
        );
      });

      return html || '<p style="color:var(--accent-dim);font-size:0.75rem;letter-spacing:0.15em;">No awards data yet.</p>';
    }

    // ── Build past season flip card ──────────────────────────
    function buildPastSeasonCard(season, league, config) {
      var isFootball = league.sport === 'football';
      var isMadness  = league.sport === 'madness';
      var year       = season.year || '????';
      var displayName = season.championTeamName || '—';
      var owner       = season.championName || '';

      // ── Image
      var imgSrc  = getChampionImage(season, config, league);
      var initial = displayName !== '—' ? displayName.charAt(0).toUpperCase()
                  : (owner ? owner.charAt(0).toUpperCase() : '?');

      var imgColHtml = imgSrc
        ? '<div class="stat-award-img-col' + (isFootball ? ' psc-img-contain' : '') + '"><img src="' + esc(imgSrc) + '" alt="' + esc(displayName) + '" /></div>'
        : '<div class="stat-award-img-col psc-initial-col"><span class="psc-initial">' + esc(initial) + '</span></div>';

      // ── Right column items
      var detailLines = [];

      if (isFootball) {
        var record = season.record || '';
        if (record) detailLines.push({ label: 'Record', value: record });
      } else if (isMadness) {
        var wb = (season.stats && season.stats.winningBracket) || {};
        var tp = (wb.totalPoints !== undefined && wb.totalPoints !== '' && wb.totalPoints !== 0) ? wb.totalPoints : '';
        if (tp) detailLines.push({ label: 'Total Points', value: tp });
      }

      var detailHtml = detailLines.map(function (d) {
        return '<div class="stat-award-detail psc-detail">' +
          '<span class="psc-detail-label">' + esc(d.label) + '</span>' +
          '<span>' + esc(d.value) + '</span>' +
        '</div>';
      }).join('');

      var infoHtml =
        '<div class="stat-award-info-col">' +
          '<div class="stat-award-name">' + esc(year) + '</div>' +
          '<div class="stat-award-winner">' + esc(displayName) + '</div>' +
          (owner ? '<div class="stat-award-hint">' + esc(owner) + '</div>' : '') +
          detailHtml +
          '<div class="psc-view-hint">View Season →</div>' +
        '</div>';

      // ── Season URL
      var seasonParam = encodeURIComponent(season.id || season.year || '');
      var leagueParam = encodeURIComponent(league.name || '');
      var seasonUrl   = 'league.html?league=' + leagueParam + '&season=' + seasonParam;

      var card = document.createElement('div');
      card.className = 'stat-award-card season-flip-card season-flip-card--link';
      card.setAttribute('role', 'link');
      card.setAttribute('tabindex', '0');
      card.setAttribute('aria-label', esc(year) + ' season details');
      card.innerHTML = imgColHtml + infoHtml;

      function navigate() { window.location.href = seasonUrl; }
      card.addEventListener('click', navigate);
      card.addEventListener('keydown', function (e) {
        if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); navigate(); }
      });

      return card;
    }

    // ── Is a season final/complete? ──────────────────────────
    // Past seasons (not current) are always treated as final.
    // Current season requires isFinal: true.
    function isSeasonFinal(season, league, isArchive) {
      if (isArchive) return true;
      var isCurrent = league.currentSeasonId
        ? season.id === league.currentSeasonId
        : season === getCurrentSeason(league);
      if (!isCurrent) return true;
      return season.isFinal === true;
    }

    // ── Migrate legacy pageLayout to sections array ──────────
    function migratePageLayout(league) {
      if (!league.pageLayout) league.pageLayout = {};
      var pl = league.pageLayout;
      if (pl.sections && pl.sections.length) return;

      var legacyMap = {
        champion:    pl.showChampion    !== false,
        story:       true,
        standings:   pl.showStandings   !== false,
        bracket:     true,
        roster:      false,
        awards:      pl.showAwards      !== false,
        pastSeasons: pl.showPastSeasons !== false
      };
      var defaultOrder = ['champion','story','standings','bracket','yahoo','roster','awards','pastSeasons'];
      pl.sections = defaultOrder.map(function (key) {
        return { key: key, enabled: legacyMap.hasOwnProperty(key) ? legacyMap[key] : true };
      });
    }

    // ── Get resolved sections list (merge saved + any new keys) ─
    function getResolvedSections(league) {
      migratePageLayout(league);
      var pl = league.pageLayout;
      var defaultOrder = ['champion','story','standings','bracket','yahoo','roster','awards','pastSeasons'];
      var savedKeys = (pl.sections || []).map(function (s) { return s.key; });
      var merged = (pl.sections || []).slice();
      defaultOrder.forEach(function (key) {
        if (savedKeys.indexOf(key) === -1) {
          var newEntry = { key: key, enabled: key !== 'roster' };
          // For yahoo specifically: always insert directly before roster
          if (key === 'yahoo') {
            var rosterIdx = merged.findIndex(function (s) { return s.key === 'roster'; });
            if (rosterIdx !== -1) {
              merged.splice(rosterIdx, 0, newEntry);
            } else {
              merged.push(newEntry);
            }
            return;
          }
          // For other new keys: insert at correct position relative to defaultOrder neighbors
          var defaultIdx = defaultOrder.indexOf(key);
          var insertAfter = -1;
          for (var i = defaultIdx - 1; i >= 0; i--) {
            var prevKey = defaultOrder[i];
            var mergedIdx = merged.findIndex(function (s) { return s.key === prevKey; });
            if (mergedIdx !== -1) { insertAfter = mergedIdx; break; }
          }
          if (insertAfter === -1) {
            merged.unshift(newEntry);
          } else {
            merged.splice(insertAfter + 1, 0, newEntry);
          }
        }
      });
      return merged;
    }

    // ── Render playoff bracket ───────────────────────────────
    function renderBracket(season, league, config) {
      var playoffs = season.playoffs;
      if (!playoffs || !Object.keys(playoffs).length) return '';

      var schema     = window.SPORT_STAT_SCHEMAS[league.sport] || window.SPORT_STAT_SCHEMAS.other;
      var roundDefs  = (schema.playoffRounds || []);
      if (!roundDefs.length) return '';

      // Build ordered round list including consolation if present
      var rounds = roundDefs.map(function (r) {
        var labels = { wildcard: 'Wild Card', semis: 'Semifinals', finals: 'Championship' };
        return { key: r, label: labels[r] || r };
      });
      if (playoffs.consolation) rounds.push({ key: 'consolation', label: 'Consolation / Toilet Bowl' });

      // Check if any round has at least one matchup with real data
      var hasData = rounds.some(function (r) {
        var games = playoffs[r.key] || [];
        return games.some(function (g) {
          return g.homeOwnerName || g.awayOwnerName || g.homeTeamName || g.awayTeamName;
        });
      });
      if (!hasData) return '';

      var html = '';
      rounds.forEach(function (round) {
        var games = playoffs[round.key];
        if (!games || !games.length) return;
        var hasRoundData = games.some(function (g) {
          return g.homeOwnerName || g.awayOwnerName || g.homeTeamName || g.awayTeamName;
        });
        if (!hasRoundData) return;

        html += '<div class="bracket-round">';
        html += '<div class="bracket-round-label">' + esc(round.label) + '</div>';
        html += '<div class="bracket-matchups">';

        games.forEach(function (g) {
          var homeScore = (g.homeScore !== '' && g.homeScore !== undefined) ? g.homeScore : '';
          var awayScore = (g.awayScore !== '' && g.awayScore !== undefined) ? g.awayScore : '';
          var homeWon = homeScore !== '' && awayScore !== '' && parseFloat(homeScore) > parseFloat(awayScore);
          var awayWon = homeScore !== '' && awayScore !== '' && parseFloat(awayScore) > parseFloat(homeScore);

          function teamHtml(memberId, teamName, ownerName, score, won) {
            var logo    = resolveRosterLogo({ memberId: memberId || '', teamName: teamName || '' }, league, config);
            var display = teamName || ownerName || '—';
            var initial = display !== '—' ? display.charAt(0).toUpperCase() : '?';
            var imgHtml = logo
              ? '<img class="standings-team-logo" src="' + esc(logo) + '" alt="' + esc(display) + '" />'
              : '<span class="standings-team-initial">' + esc(initial) + '</span>';
            return '<div class="bracket-team' + (won ? ' bracket-team--winner' : '') + '">' +
              '<span class="standings-team-cell bracket-team-name">' + imgHtml + esc(display) + '</span>' +
              (score !== '' ? '<span class="bracket-team-score">' + esc(score) + '</span>' : '') +
            '</div>';
          }

          html += '<div class="bracket-matchup">' +
            teamHtml(g.homeMemberId, g.homeTeamName, g.homeOwnerName, homeScore, homeWon) +
            '<div class="bracket-vs">vs</div>' +
            teamHtml(g.awayMemberId, g.awayTeamName, g.awayOwnerName, awayScore, awayWon) +
          '</div>';
        });

        html += '</div></div>';
      });

      return html
        ? '<div class="bracket-grid">' + html + '</div>'
        : '';
    }

    // ── Resolve logo for a roster entry ─────────────────────
    // Priority: season.roster[].logo → master roster team logo → mugshot → ''
    function resolveRosterLogo(entry, league, config) {
      // 1. Logo stored directly on the season roster entry (snapshot at creation)
      if (entry.logo) return entry.logo;

      // 2. Look up current logo from master roster
      var member = (config.masterRoster || []).find(function (m) {
        return m.id === entry.memberId;
      });
      if (!member) return '';

      // 3. Find the member's league entry
      var lgEntry = (member.leagues || []).find(function (lg) {
        return lg.leagueKey === league.name || lg.leagueName === league.name;
      });

      if (lgEntry && lgEntry.teams && lgEntry.teams.length) {
        // 4. Match by team name first, then fall back to first team
        var teamName = entry.teamName || '';
        var team = (teamName
          ? lgEntry.teams.find(function (t) { return t.name === teamName; })
          : null) || lgEntry.teams[0];

        if (team && team.logo) return team.logo;
      }

      // 5. Mugshot fallback
      return member.mugshot || '';
    }

    // ── Render season roster grid ────────────────────────────
    function renderRoster(season, league, config) {
      var roster = season.roster || [];
      if (!roster.length) return '';

      // Sort roster to match standings order; unsorted members go to the end
      var standings = season.standings || [];
      var rankMap   = {};
      standings.forEach(function (row, i) {
        if (row.memberId) rankMap[row.memberId] = i;
      });
      var sorted = roster.slice().sort(function (a, b) {
        var ra = rankMap.hasOwnProperty(a.memberId) ? rankMap[a.memberId] : 9999;
        var rb = rankMap.hasOwnProperty(b.memberId) ? rankMap[b.memberId] : 9999;
        return ra - rb;
      });

      var html = sorted.map(function (entry) {
        var name    = entry.teamName || '';
        var logo    = resolveRosterLogo(entry, league, config);
        var initial = name ? name.charAt(0).toUpperCase() : '?';

        var imgHtml = logo
          ? '<img class="roster-card-logo" src="' + esc(logo) + '" alt="' + esc(name) + '" />'
          : '<div class="roster-card-initial">' + esc(initial) + '</div>';

        return '<div class="roster-card">' +
          imgHtml +
          '<div class="roster-card-name">' + esc(name || entry.ownerName || '—') + '</div>' +
        '</div>';
      }).join('');

      return '<div class="roster-grid">' + html + '</div>';
    }

    // ── Find a season by id or year string ──────────────────
    function findSeason(league, param) {
      if (!param) return null;
      return (league.seasons || []).find(function (s) {
        return String(s.id) === param || String(s.year) === param;
      }) || null;
    }

    // ── Render page body ─────────────────────────────────────
    function renderBody(league, config) {
      var body        = el('leagueBody');
      var pl          = league.pageLayout || {};
      var seasonParam = getParam('season');
      var archived    = seasonParam ? findSeason(league, seasonParam) : null;
      var current     = archived || getCurrentSeason(league);
      var isArchive   = !!archived;
      var isFinal     = isSeasonFinal(current, league, isArchive);

      var pastSeasons = isArchive ? [] : (league.seasons || []).filter(function (s) {
        return s.id !== (current ? current.id : null);
      });

      body.innerHTML = '';
      var revealDelay = 0.8;

      // ── Archive breadcrumb (always shown when in archive view)
      if (isArchive) {
        var backUrl = 'league.html?league=' + encodeURIComponent(league.name || '');
        var bread = document.createElement('div');
        bread.className = 'league-section league-section-first league-breadcrumb section-reveal';
        bread.style.animationDelay = revealDelay + 's';
        revealDelay += 0.1;
        bread.innerHTML =
          '<a class="breadcrumb-link" href="' + backUrl + '">' +
            '&#8592; ' + esc(league.fullName || league.name || 'League') +
          '</a>' +
          '<span class="breadcrumb-sep">/</span>' +
          '<span class="breadcrumb-current">' + esc(current ? (current.year || seasonParam) : seasonParam) + ' Season</span>';
        body.appendChild(bread);
      }

      // ── Resolve ordered sections
      var sections = getResolvedSections(league);
      var isFirst  = !isArchive; // first content section gets league-section-first

      sections.forEach(function (sec) {
        if (!sec.enabled) return;

        var key = sec.key;
        var sectionEl = null;

        // ── Champion ──────────────────────────────────────
        if (key === 'champion') {
          if (!current || !current.championName || !isFinal) return;
          sectionEl = document.createElement('div');
          sectionEl.innerHTML = renderChampionBlock(current, league, config);
        }

        // ── Yahoo! League Link ─────────────────────────────
        else if (key === 'yahoo') {
          if (!current || !current.yahooUrl || !current.showYahooLink) return;
          sectionEl = document.createElement('div');
          sectionEl.innerHTML =
            '<div class="yahoo-link-wrap">' +
              '<a class="yahoo-link-btn" href="' + esc(current.yahooUrl) + '" target="_blank" rel="noopener">' +
                '<svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 14H9V8h2v8zm4 0h-2V8h2v8z"/></svg>' +
                'View on Yahoo!' +
              '</a>' +
            '</div>';
        }

        // ── Season Story ──────────────────────────────────
        else if (key === 'story') {
          if (!current || !current.story || !isFinal) return;
          sectionEl = document.createElement('div');
          sectionEl.innerHTML =
            '<div class="league-section-heading">Season Story</div>' +
            '<p class="season-story-text">' + esc(current.story) + '</p>';
        }

        // ── Final Standings ───────────────────────────────
        else if (key === 'standings') {
          if (!current) return;
          sectionEl = document.createElement('div');
          sectionEl.innerHTML =
            '<div class="league-section-heading">' + (isFinal ? 'Final Standings' : 'Standings') +
              (current.year ? ' \u2014 ' + esc(current.year) : '') +
            '</div>' +
            '<div class="league-standings-wrap">' + renderStandingsTable(current, league, config) + '</div>';
        }

        // ── Playoff Bracket ───────────────────────────────
        else if (key === 'bracket') {
          if (!current) return;
          var bracketHtml = renderBracket(current, league, config);
          if (!bracketHtml) return;
          sectionEl = document.createElement('div');
          sectionEl.innerHTML =
            '<div class="league-section-heading">Playoff Bracket' +
              (current.year ? ' \u2014 ' + esc(current.year) : '') +
            '</div>' + bracketHtml;
        }

        // ── Season Roster ─────────────────────────────────
        else if (key === 'roster') {
          if (!current) return;
          var rosterHtml = renderRoster(current, league, config);
          if (!rosterHtml) return;
          sectionEl = document.createElement('div');
          sectionEl.innerHTML =
            '<div class="league-section-heading">Roster' +
              (current.year ? ' \u2014 ' + esc(current.year) : '') +
            '</div>' + rosterHtml;
        }

        // ── Season Awards ─────────────────────────────────
        else if (key === 'awards') {
          if (!current || !isFinal) return;
          sectionEl = document.createElement('div');
          sectionEl.innerHTML =
            '<div class="league-section-heading">Awards' +
              (current.year ? ' \u2014 ' + esc(current.year) : '') +
            '</div>' +
            '<div class="awards-grid">' + renderAwardsGrid(current, league) + '</div>';
        }

        // ── Past Seasons ──────────────────────────────────
        else if (key === 'pastSeasons') {
          if (isArchive || !pastSeasons.length) return;
          sectionEl = document.createElement('div');
          sectionEl.innerHTML = '<div class="league-section-heading">Past Seasons</div>';
          var grid = document.createElement('div');
          grid.className = 'past-seasons-grid';
          pastSeasons.forEach(function (s) {
            grid.appendChild(buildPastSeasonCard(s, league, config));
          });
          sectionEl.appendChild(grid);
        }

        if (!sectionEl) return;

        sectionEl.className = 'league-section section-reveal' +
          (isFirst ? ' league-section-first' : '');
        sectionEl.style.animationDelay = revealDelay + 's';
        revealDelay += 0.15;
        isFirst = false;
        body.appendChild(sectionEl);
      });

      // ── Footer (always)
      var footer = document.createElement('div');
      footer.className = 'league-footer section-reveal';
      footer.style.animationDelay = revealDelay + 's';
      footer.textContent = (league.fullName || league.name || '') +
        (config.footer && config.footer.text ? ' \u00B7 ' + config.footer.text : '');
      body.appendChild(footer);
    }

    // ── Init slideshow for league ────────────────────────────
    function initLeagueSlideshow(league, config) {
      var ss = league.slideshow;

      // Apply league overlay directly as inline style (same mechanism as index page)
      var overlayEl = el('heroOverlay');
      var overlayVal = (ss && ss.overlay) ? ss.overlay : 'rgba(0,0,0,0.55)';
      if (overlayEl) overlayEl.style.background = overlayVal;

      if (!ss || !ss.slides || !ss.slides.length) return;

      // Borrow global slideshow timing settings if set
      var displayMs = (config.slideshow && config.slideshow.displayDuration) || 8000;
      var fadeMs    = (config.slideshow && config.slideshow.fadeDuration)    || 2000;
      var cycleMs   = displayMs + fadeMs;
      document.documentElement.style.setProperty('--slide-fade', (fadeMs / 1000) + 's');

      var slideA     = el('slideA');
      var slideB     = el('slideB');
      if (!slideA || !slideB) return;

      var slides     = ss.slides;
      var total      = slides.length;
      var currentIdx = 0;
      var activLayer = slideA;
      var inactLayer = slideB;

      slides.forEach(function (s) { var img = new Image(); img.src = s.image; });

      function applySlide(layer, slide) {
        layer.style.backgroundImage    = 'url("' + slide.image + '")';
        layer.style.animationName      = slide.direction || 'kb-zoom-in';
        layer.style.animationDuration  = cycleMs + 'ms';
        layer.style.animationDelay     = '0ms';
        layer.style.animationPlayState = 'paused';
        layer.classList.add('kb-active');
      }

      function resetLayer(layer) {
        layer.classList.remove('kb-active');
        layer.style.animation = 'none';
        void layer.offsetWidth;
        layer.style.animation = '';
      }

      function showSlide(idx) {
        applySlide(inactLayer, slides[idx]);
        activLayer.style.zIndex  = '1';
        inactLayer.style.zIndex  = '2';
        inactLayer.style.animationPlayState = 'running';
        inactLayer.classList.add('is-active');
        setTimeout(function () {
          activLayer.classList.remove('is-active');
          var out = activLayer; activLayer = inactLayer; inactLayer = out;
          setTimeout(function () { resetLayer(inactLayer); }, 50);
        }, fadeMs);
      }

      applySlide(slideA, slides[0]);
      slideA.style.zIndex = '2';
      slideB.style.zIndex = '1';
      slideA.style.animationPlayState = 'running';
      slideA.classList.add('is-active');
      activLayer = slideA;
      resetLayer(slideB);
      inactLayer = slideB;

      if (total === 1) return;

      function cycle() {
        currentIdx = (currentIdx + 1) % total;
        showSlide(currentIdx);
        setTimeout(cycle, cycleMs);
      }
      setTimeout(cycle, cycleMs);
    }

    // ── Main init ────────────────────────────────────────────
    function init() {
      var config = window.SITE_CONFIG;
      if (!config) { console.warn('SITE_CONFIG not found'); return; }

      var slug   = getParam('league');
      var league = getLeague(slug);

      if (!league) {
        document.title = 'OFL \u2014 League Not Found';
        el('leagueTitle').textContent    = slug ? slug.toUpperCase() : 'League';
        el('leagueSubtitle').textContent = 'This league could not be found.';
        return;
      }

      renderHero(league, config);
      initLeagueSlideshow(league, config);

      // Update page title for archived season view
      var seasonParam = getParam('season');
      if (seasonParam) {
        var archivedSeason = (league.seasons || []).find(function (s) {
          return String(s.id) === seasonParam || String(s.year) === seasonParam;
        });
        var yearLabel = archivedSeason ? (archivedSeason.year || seasonParam) : seasonParam;
        document.title = 'OFL \u2014 ' + (league.heroTitle || league.name || 'League') + ' ' + yearLabel;
      }

      renderBody(league, config);
    }

    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', init);
    } else {
      init();
    }

  })();
  </script>

</body>
</html>
